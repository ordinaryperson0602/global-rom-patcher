# 🔧 Global ROM Patcher - Lenovo Tablet 롬파일 패치 자동화 도구

**Lenovo 태블릿** 롬파일 패치 및 관리 도구입니다.

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
---

## ⚠️ 중요: 사용 전 필독

> **이 도구는 기기의 시스템 파티션을 직접 수정합니다.**

### 🚨 위험성
- 기기가 영구적으로 고장날 수 있습니다 (벽돌화)
- 제조사 보증이 즉시 무효화됩니다
- 데이터가 완전히 삭제될 수 있습니다
- A/S를 받을 수 없게 될 수 있습니다

### 📜 책임
- **모든 결과는 사용자 본인의 책임**입니다
- 개발자는 어떠한 손해에 대해서도 책임지지 않습니다
- 이 도구는 **교육 목적**으로만 제공됩니다

**계속 진행하시려면 위험성을 충분히 이해하셨다는 의미로 간주합니다.**

---

## 📌 목차

- [기능 소개](#-기능-소개)
- [시스템 요구사항](#-시스템-요구사항)
- [설치 방법](#-설치-방법)
- [빠른 시작](#-빠른-시작)
- [상세 사용법](#-상세-사용법)
- [출력 결과물](#-출력-결과물)
- [문제 해결](#-문제-해결)
- [기술 세부사항](#-기술-세부사항)
- [라이선스](#-라이선스)
- [도움말](#-도움말)

---

## ✨ 기능 소개

### 🎯 주요 기능

| 기능 | 설명 | 위험도 |
|------|------|--------|
| **RSA 롬 자동 패치** | RSA 다운로드 폴더의 공식 롬 자동 분석 및 패치 | ⚠️ 중간 |
| **커스텀 롤 패치** | 외부 롬파일 자동 분석 및 호환성 검증 | ⚠️ 중간 |
| **국가 코드 변경** | 중국 롬(CN) → 한국 롬(KR) 자동 변환 | 🚨 높음 |
| **기기 백업** | 3개 파티션 백업 및 복구 지점 생성 | ✅ 낮음 |

### 🔍 작동 원리

이 도구는 Lenovo 일부 기기의 **AOSP 테스트 키** 서명 취약점을 활용합니다.

```
부트로더 잠김 상태 → AOSP 테스트 키로 서명 → 수정된 이미지 부팅 가능
```

이를 통해 부트로더 잠금 해제 없이도 시스템 수정이 가능합니다.

### 🎮 지원 기기

- ✅ **Lenovo Yoga Pad Pro (TB520FU)** - 전체 변형 (CN/ROW) - 주요 타겟
- ✅ **Lenovo Tab Extreme (TB321FU)** - 호환 가능 (일부 검증됨)
- ❓ **기타 Lenovo 태블릿** - AOSP 테스트 키 사용 기기라면 가능 (미검증)

---

## 💻 시스템 요구사항

### 필수 사항

#### 하드웨어
```
✓ 지원되는 Lenovo 태블릿 (TB520FU, TB321FU, TB710FU 등)
✓ Windows PC (Windows 10/11 64비트)
✓ USB 2.0 포트 (USB 3.0보다 EDL 통신 안정적)
✓ 짧은 USB 케이블 (1m 이하, 통신 안정성)
```

#### 소프트웨어
```
✓ 관리자 권한 계정
✓ Qualcomm EDL 드라이버
✓ Python 3.8+ (소스 실행 시) 또는 EXE 파일
```

### 권장 사항
- 💾 안정적인 전원 공급 (EDL 작업 중 전원 차단 시 벽돌화 위험)
- 🔌 직접 연결 (USB 허브 사용 금지)
- 📦 최소 30GB 여유 공간

---

## 📥 설치 방법

### 옵션 A: EXE 파일 사용 (초보자 권장)

**가장 쉬운 방법입니다. Python 설치 불필요!**

1. **다운로드**
   - [Releases 페이지](../../releases)에서 최신 버전 다운로드
   - `ROM_Tool_vX.X.X.zip` 파일 다운로드

2. **압축 해제**
   - 원하는 위치에 압축 해제
   - 경로에 한글이 포함되어도 무방

3. **실행**
   - `ROM_Tool.exe` 우클릭 → **관리자 권한으로 실행**

### 옵션 B: Python 소스 실행 (개발자)

**코드 수정이 필요하거나 개발에 참여하려면 이 방법을 사용하세요.**

```bash
# 1. 저장소 복제
git clone https://github.com/ordinaryperson0602/global-rom-patcher.git
cd global-rom-patcher

# 2. 가상환경 생성 (선택사항)
python -m venv venv
venv\Scripts\activate

# 3. 의존성 설치
pip install -r requirements.txt

# 4. 실행
python main.py
```

---

## 🚀 빠른 시작

### 1단계: 사용자 동의

프로그램 실행 시 `프로그램_사용자_동의서.txt`가 자동으로 열립니다.

- 내용을 **반드시 읽으세요**
- 콘솔 창에 **"동의"** 입력 (정확히)
- 3번의 입력 기회 제공

### 2단계: 모드 선택

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         ROM Tool - Main Menu
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[일반 모드 - 전체 자동화]
1. RSA 공식 롬파일 자동 패치
2. 사용자 지정 롬파일 자동 패치
3. 국가코드 자동 패치 (CN→KR)
4. 기기 정보 백업

[개발자 모드 - 단계별 수동]
d. 개발자 모드 진입
```

### 3단계: 작업 실행

선택한 번호를 입력하면 **전체 과정이 자동으로 진행**됩니다:

```
✓ ADB 연결 확인
✓ EDL 모드 진입
✓ 기기 정보 추출
✓ 롬파일 분석
✓ 백업 생성
✓ 패치 실행
✓ 검증 완료
```

### 4단계: 결과 확인

작업 완료 후:
- `ROM/[롬이름]/image/` 폴더에 패치된 파일 생성
- RSA 업데이트 도구로 플래싱

---

## 📖 상세 사용법

### 🔹 RSA 공식 롬 자동 패치

**RSA 다운로드 폴더의 롬을 자동으로 찾아 패치합니다.**

#### 사전 준비
1. RSA 업데이트 도구로 롬 다운로드
2. 기본 경로: `C:\ProgramData\RSA\Download\RomFiles\`
3. 롬파일 압축 해제 완료 확인

#### 실행 과정
```
메인 메뉴 → 1 선택
  ↓
롬 폴더 자동 감지 (TB520FU_*)
  ↓
사용자 선택 (여러 개 있을 경우)
  ↓
자동 검증 및 패치
  ↓
완료 (ROM 폴더에 결과물 생성)
```

#### 자동 검증 항목
- ✅ **1차 검증**: 폴더 이름에서 모델 번호 확인
- ✅ **2차 검증**: vbmeta Prop에서 모델 번호 재확인
- ✅ **Hex 검증**: vendor_boot에서 국가 코드 확인
- ✅ **롤백 검증**: 기기와 롬의 rollback index 비교

---

### 🔹 사용자 지정 롬 패치

**외부에서 다운로드한 롬파일을 패치합니다.**

#### 지원 형식
```
✓ 표준 구조: ROM_NAME/image/*.img
✓ 플랫 구조: ROM_NAME/*.img
✓ OTA 구조: 자동 감지 및 처리
```

#### 실행 과정
```
메인 메뉴 → 2 선택
  ↓
파일 탐색기에서 롬 폴더 선택
  ↓
롬 타입 자동 감지 (CN/ROW)
  ↓
모델 호환성 자동 검증
  ↓
패치 및 저장
```

#### 취소 후 재시도
폴더 선택을 취소하면:
```
다시 선택하시겠습니까?
  y → 폴더 선택 다시 표시
  n → 메인 메뉴로 복귀
```

---

### 🔹 국가 코드 변경 (CN → KR)

**중국 롬을 한국 롬으로 변환합니다.**

#### ⚠️ 경고
- 매우 위험한 작업입니다
- 3개 파티션을 직접 수정합니다
- 실패 시 기기 벽돌화 가능

#### 수정 파티션
```
1. persist.img   - 지역 설정 저장
2. devinfo.img   - 기기 정보
3. keystore.img  - 보안 키 저장소
```

#### 실행 과정
```
메인 메뉴 → 3 선택
  ↓
EDL 모드 자동 진입
  ↓
파티션 읽기 → 패치 → 쓰기
  ↓
자동 재부팅
```

---

### 🔹 기기 정보 백업

**기기의 중요 파티션을 백업합니다.**

#### 백업 내용 (총 3개 파티션 + 정보 파일)
```
1. persist.img   - 지역 설정 및 영구 데이터
2. devinfo.img   - 기기 정보 및 잠금 상태
3. keystore.img  - 보안 키 저장소
4. device_info.txt - 기기 모델, 국가코드, 롤백 인덱스 등 요약 정보
```

#### 백업 위치
```
Device_Info_20251104_123456/
  ├── persist.img        ← 백업됨
  ├── devinfo.img        ← 백업됨
  ├── keystore.img       ← 백업됨
  └── device_info.txt    ← 기기 정보 요약 (모델/국가/롤백 인덱스)
```

**참고**: `vbmeta`, `boot` 등 다른 파티션은 롤백 인덱스 확인용으로만 추출되며 백업 폴더에는 저장되지 않습니다.

---

## 📦 출력 결과물

### 디렉토리 구조

작업 완료 후 생성되는 폴더:

```
프로젝트_루트/
│
├── ROM/                              # 패치된 롬 파일
│   ├── TB520FU_ROW_xxx/              # 패치된 롬
│   │   └── image/
│   │       ├── vbmeta.img           ← 패치됨 (AOSP 키)
│   │       ├── vendor_boot.img      ← 패치됨 (지역역코드)
│   │       └── ...기타 원본 파일
│   │
│   └── TB520FU_ROW_xxx_RAW/          # 원본 백업
│       └── image/
│           └── ...원본 파일 (변경 전)
│
├── Device_Info_[timestamp]/          # 기기 백업
│   ├── persist.img                  # 지역 설정
│   ├── devinfo.img                  # 기기 정보
│   ├── keystore.img                 # 보안 키
│   └── device_info.txt              # 기기 정보 요약 (모델/국가/롤백)
│
└── Output/
    └── Logs/
        └── app_[timestamp].log      # 상세 로그
```

### 로그 파일

모든 작업 내역은 `Output/Logs/app_*.log`에 기록됩니다.

**로그 내용:**
- 🔹 모든 명령어 실행 및 결과
- 🔹 검증 단계별 결과
- 🔹 오류 발생 시 상세 traceback
- 🔹 실행 시간 및 성능 정보

**특징:**
- 콘솔에는 간략한 정보만 표시
- 파일에는 모든 세부사항 기록
- ANSI 색상 코드 자동 제거

---

## 🔧 문제 해결

### 자주 발생하는 오류

#### ❌ "EDL 기기가 연결되지 않았습니다"

**원인:**
- EDL 드라이버 미설치
- USB 연결 불량
- 기기가 EDL 모드에 진입하지 않음

**해결방법:**
```
1. USB 케이블 재연결
2. USB 2.0 포트 사용
3. EDL 드라이버 재설치
4. 다른 USB 케이블 시도
```

---

#### ❌ "모델 번호가 일치하지 않습니다"

**원인:**
- 잘못된 모델의 롬 선택 (예: TB321FU 롬을 TB520FU 기기에 사용)

**해결방법:**
```
올바른 모델의 롬파일을 선택하세요
- TB520FU 기기 → TB520FU 롬 필수
- TB321FU 기기 → TB321FU 롬 필수
```

---

#### ❌ "GPT parsing error"

**원인:**
- 기기가 EDL 모드 대신 Fastboot 모드로 진입

**해결방법:**
```
1. 기기 재부팅
2. EDL 모드로 재진입
3. 프로그램 재실행
```

---

#### ⚠️ "파일이 이미 존재합니다"

**설명:**
- 정상 동작입니다 (경고일 뿐)
- 이미 추출된 파일을 재사용하여 시간 절약

**조치:**
- 무시하고 계속 진행

---

### 에러 발생 시 대처

1. **로그 확인**
   - `Output/Logs/` 폴더의 최신 로그 파일 확인
   - 에러 메시지 및 traceback 확인

2. **임시 파일 정리**
   - 프로그램이 자동으로 정리
   - 수동 정리: `.img` 파일 삭제

3. **백업 복원**
   - `_RAW` 폴더에서 원본 복원 가능
   - 자동 복원 기능 내장

4. **도움 요청**
   - GitHub Issues에 로그 파일 첨부
   - 재현 단계 설명

---

## 🛠️ 기술 세부사항

### 아키텍처

```
┌─────────────────┐
│   main.py       │  ← 진입점 및 메뉴
└────────┬────────┘
         │
    ┌────┴─────┬──────────┬──────────┐
    │          │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Step 1 │  │Step 2 │  │Step 3 │  │Step 4 │
│Extract│  │Analyze│  │ Patch │  │Verify │
└───┬───┘  └───┬───┘  └───┬───┘  └───┬───┘
    │          │          │          │
    └──────────┴────┬─────┴──────────┘
                    │
           ┌────────▼────────┐
           │  Core Modules   │
           ├─────────────────┤
           │ - logger        │
           │ - progress      │
           │ - config        │
           │ - exceptions    │
           └─────────────────┘
                    │
           ┌────────▼────────┐
           │   Utilities     │
           ├─────────────────┤
           │ - edl_workflow  │
           │ - country_code  │
           │ - backup_device │
           │ - command       │
           └─────────────────┘
```

### 핵심 기술

#### Structlog 로깅
```python
# 구조화된 로깅으로 디버깅 용이
info("STEP 시작", step="2", target_model="TB520FU")
log_validation("모델 확인", result="OK", model="TB520FU")
log_error("오류 발생", exception=e, context="Step3")
```

#### 진행률 실시간 표시
```python
# 계층적 진행률 표시
━━━━━━━━━━ 전체 진행: STEP 2/4 (50%) ━━━━━━━━━━
[STEP 2: 롬파일 분석] ████████-------- 50%
  ✓ 롬파일 경로 확인
  → vbmeta Prop 확인
  ○ vendor_boot Hex 확인
```

#### 에러 처리 데코레이터
```python
@handle_step_error(step_name="STEP 2")
def run_step_2(...):
    # 에러 발생 시 자동으로 메인 메뉴로 복귀
    pass
```

#### QuickEdit 자동 비활성화
```python
# Windows 콘솔 클릭 시 멈춤 방지
disable_quickedit_mode()  # 시작 시
restore_console_mode()    # 종료 시
---

## 📜 라이선스

이 프로젝트는 **제한적 라이선스**를 따릅니다.

- ❌ **상업적 사용 금지**
- ❌ **수정 및 재배포 금지**
- ✅ **개인 사용만 허용**
- ⚠️ **보증 없음** (있는 그대로 제공)

자세한 내용: [LICENSE](LICENSE) 파일 참조

---

## 💬 도움말

### 📞 연락처

- **개발자**: Ordinary_Person
- **프로젝트**: [GitHub Repository](https://github.com/ordinaryperson0602/global-rom-patcher)
- **이슈 리포트**: [GitHub Issues](https://github.com/ordinaryperson0602/global-rom-patcher/issues)

### 🙏 기여

기여는 언제나 환영합니다!

1. 이슈 또는 버그 리포트
2. 기능 제안
3. Pull Request
4. 문서 개선

### 📚 참고 자료

이 프로젝트는 다음 도구들을 사용합니다:

- **[Google AVBTool](https://android.googlesource.com/platform/external/avb/)** - Android Verified Boot
- **EDL-NG** - Qualcomm EDL 통신
- **Android Platform Tools** - ADB/Fastboot
- **[jjhitel](https://github.com/jjhitel/LTBox/releases/tag/v1.7.2)** - 롬 패치 일부부 인용

---

## ⚡ 마지막 경고

```
┌─────────────────────────────────────────────┐
│                                             │
│  이 도구를 사용하기 전에 반드시:             │
│                                             │
│  ✓ 중요한 데이터를 백업하세요                │
│  ✓ 위험성을 완전히 이해하세요                │
│  ✓ 안정적인 USB 연결을 확인하세요            │
│  ✓ 올바른 모델의 롬을 선택하세요             │
│  ✓ 작업 중 절대 중단하지 마세요              │
│                                             │
│  한 번의 실수로 기기가 영구 손상될 수 있습니다│
│                                             │
└─────────────────────────────────────────────┘
```

**모든 책임은 사용자 본인에게 있습니다.**

**충분히 이해하셨다면, 이제 시작하세요! 🚀**
